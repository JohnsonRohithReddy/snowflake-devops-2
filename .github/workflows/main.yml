name: snowflake-devops-demo

on:
  push:
    branches:
      - main
    paths:
      - 'bronze/migrations/**'
  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Use Python 3.8.x
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.8.x

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run schemachange for bronze
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE_DEV }}  # Optional override
          SF_SCHEMA_BRONZE: ${{ secrets.SF_SCHEMA_BRONZE }}  # Optional override
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD }}
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          python --version
          echo "Step 1: Installing schemachange"
          pip install schemachange
          
          echo "Step 2: Deploying bronze"
          if [ -d "$GITHUB_WORKSPACE/bronze/migrations" ]; then
            echo "Loading variables from bronze-var.yml"
            # Debug: Check if file exists
            if [ -f "$GITHUB_WORKSPACE/bronze/migrations/bronze-var.yml" ]; then
              echo "File found, parsing..."
              vars=$(python -c "import yaml, json; f = open('$GITHUB_WORKSPACE/bronze/migrations/bronze-var.yml'); data = yaml.safe_load(f); f.close(); vars_data = data.get('variables', {}); print(json.dumps({'database_name': vars_data.get('sf_database'), 'schema_name': vars_data.get('sf_schema')}))")
              echo "Parsed vars: $vars"
            else
              echo "Error: bronze-var.yml not found"
              vars='{"database_name": "default_db", "schema_name": "default_schema"}'
            fi
            database_name=$(echo "$vars" | python -c "import json, sys; print(json.loads(sys.stdin.read())['database_name'])")
            schema_name=$(echo "$vars" | python -c "import json, sys; print(json.loads(sys.stdin.read())['schema_name'])")
            echo "Extracted database_name: $database_name"
            echo "Extracted schema_name: $schema_name"
            database_name="${SF_DATABASE:-$database_name}"
            schema_name="${SF_SCHEMA_BRONZE:-$schema_name}"
            echo "Final database_name: $database_name"
            echo "Final schema_name: $schema_name"
            schemachange -f "$GITHUB_WORKSPACE/bronze/migrations/scripts" -a "$SF_ACCOUNT" -u "$SF_USERNAME" -r "$SF_ROLE" -w "$SF_WAREHOUSE" -d "$database_name" -c "$database_name.SCHEMACHANGE.CHANGE_HISTORY" --create-change-history-table --config-folder "$GITHUB_WORKSPACE/bronze/migrations/config" --vars "$vars"
          else
            echo "Skipping bronze: No migrations folder"
          fi
